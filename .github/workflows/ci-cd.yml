name: CI/CD Pipeline Complet

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # ================================
  # Ã‰TAPE 1 : TESTS
  # ================================
  test-backend:
    name: ðŸ§ª Tests Backend
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ðŸ“¦ Installation
        working-directory: ./backend
        run: npm ci

      - name: ðŸ§ª Tests
        working-directory: ./backend
        run: npm test

  # ================================
  # Ã‰TAPE 2 : QUALITÃ‰ DU CODE
  # ================================
  code-quality:
    name: ðŸ“Š QualitÃ© du Code
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ðŸ“¦ Installation
        working-directory: ./backend
        run: npm ci

      - name: ðŸ” Syntaxe
        working-directory: ./backend
        run: |
          node --check server.js
          find src -name "*.js" -exec node --check {} \;

      - name: ðŸ”’ Audit SÃ©curitÃ©
        working-directory: ./backend
        run: npm audit --audit-level=moderate
        continue-on-error: true

  # ================================
  # Ã‰TAPE 3 : DÃ‰PLOIEMENT (uniquement sur push main)
  # ================================
  deploy-backend:
    name: ðŸš€ DÃ©ployer Backend
    runs-on: ubuntu-latest
    needs: [test-backend, code-quality]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production-backend
      url: https://portfolio-backend-uj9f.onrender.com

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸš€ DÃ©ploiement Render
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.RENDER_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}
          wait-for-success: true

      - name: âœ… Health Check
        run: |
          sleep 30
          curl -f https://portfolio-backend-uj9f.onrender.com/api/health

  deploy-frontend:
    name: ðŸš€ DÃ©ployer Frontend
    runs-on: ubuntu-latest
    needs: [deploy-backend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Configuration Pages
        uses: actions/configure-pages@v4

      - name: ðŸ“¦ PrÃ©paration
        run: |
          mkdir -p _site
          cp -r frontend/public/* _site/

      - name: ðŸ“¤ Upload
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: ðŸš€ DÃ©ploiement
        id: deployment
        uses: actions/deploy-pages@v4

  # ================================
  # Ã‰TAPE 4 : VÃ‰RIFICATION POST-DÃ‰PLOIEMENT
  # ================================
  post-deploy-checks:
    name: âœ… VÃ©rifications Finales
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ” Test Backend
        run: |
          echo "ðŸ” Test des endpoints backend..."
          curl -f https://portfolio-backend-uj9f.onrender.com/api/health
          curl -f https://portfolio-backend-uj9f.onrender.com/api/portfolio/profile
          curl -f https://portfolio-backend-uj9f.onrender.com/api/portfolio/experience
          echo "âœ… Backend OK"

      - name: ðŸ“Š Rapport de DÃ©ploiement
        run: |
          echo "## ðŸŽ‰ DÃ©ploiement RÃ©ussi" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ URLs" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”¹ Backend: https://portfolio-backend-uj9f.onrender.com" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”¹ Frontend: https://asinda.github.io/portofolio" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â„¹ï¸ Informations" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“… Date: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”– Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‘¤ Auteur: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
