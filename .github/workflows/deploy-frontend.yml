name: DÃ©ploiement Frontend (GitHub Pages)

on:
  push:
    branches: [main]
  workflow_dispatch:

# Permissions nÃ©cessaires pour dÃ©ployer sur GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# EmpÃªche les dÃ©ploiements simultanÃ©s
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    name: Construction du site
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ”§ Configuration de GitHub Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¦ PrÃ©paration des fichiers
        run: |
          echo "ğŸ“¦ Copie des fichiers frontend..."
          mkdir -p _site
          cp -r frontend/public/* _site/

          # VÃ©rifier que les fichiers essentiels sont prÃ©sents
          if [ ! -f "_site/index.html" ]; then
            echo "âŒ Erreur: index.html manquant"
            exit 1
          fi

          echo "âœ… Fichiers prÃ©parÃ©s avec succÃ¨s"
          ls -la _site/

      - name: âœ… Validation HTML (optionnel)
        continue-on-error: true
        run: |
          echo "ğŸ” VÃ©rification de la structure HTML..."
          if grep -q "<!DOCTYPE html>" _site/index.html; then
            echo "âœ… Structure HTML valide"
          else
            echo "âš ï¸ Warning: DOCTYPE manquant"
          fi

      - name: ğŸ” VÃ©rification de la configuration API
        run: |
          echo "ğŸ” VÃ©rification de apiConfig.js..."
          if grep -q "portfolio-backend-uj9f.onrender.com" _site/js/apiConfig.js; then
            echo "âœ… URL backend configurÃ©e"
          else
            echo "âš ï¸ Warning: VÃ©rifiez l'URL backend dans apiConfig.js"
          fi

      - name: ğŸ“¤ Upload de l'artefact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

  deploy:
    name: DÃ©ploiement sur GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ğŸš€ DÃ©ploiement sur GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: â³ Attente de la propagation
        run: |
          echo "â³ Attente de la propagation du dÃ©ploiement..."
          sleep 15

      - name: âœ… VÃ©rification du dÃ©ploiement
        run: |
          echo "ğŸ” VÃ©rification du site dÃ©ployÃ©..."
          PAGE_URL="${{ steps.deployment.outputs.page_url }}"

          response=$(curl -s -o /dev/null -w "%{http_code}" "$PAGE_URL")

          if [ $response -eq 200 ]; then
            echo "âœ… Site dÃ©ployÃ© avec succÃ¨s !"
            echo "ğŸ”— URL: $PAGE_URL"
          else
            echo "âš ï¸ Warning: Site rÃ©pond avec HTTP $response"
            echo "Le site peut prendre quelques minutes pour Ãªtre disponible"
          fi

      - name: ğŸ“¢ Notification de succÃ¨s
        if: success()
        run: |
          echo "ğŸ‰ Frontend dÃ©ployÃ© avec succÃ¨s !"
          echo "ğŸ”— URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”– Commit: ${{ github.sha }}"

      - name: ğŸ“Š RÃ©sumÃ© du dÃ©ploiement
        if: always()
        run: |
          echo "## ğŸ“Š RÃ©sumÃ© du DÃ©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”— **URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“… **Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”– **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Statut**: DÃ©ployÃ©" >> $GITHUB_STEP_SUMMARY
