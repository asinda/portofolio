name: DÃ©ploiement Backend (Render)

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'render.yaml'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement de dÃ©ploiement'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  test:
    name: Tests avant dÃ©ploiement
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ğŸ“¦ Installation des dÃ©pendances
        working-directory: ./backend
        run: npm ci

      - name: ğŸ§ª ExÃ©cution des tests
        working-directory: ./backend
        run: npm test
        env:
          NODE_ENV: test

  deploy:
    name: DÃ©ploiement sur Render
    runs-on: ubuntu-latest
    needs: test
    environment:
      name: production
      url: https://portfolio-backend-uj9f.onrender.com

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸš€ DÃ©clenchement du dÃ©ploiement Render
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.RENDER_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}
          wait-for-success: true

      - name: â³ Attente de la disponibilitÃ© du service
        run: |
          echo "â³ Attente du dÃ©marrage du service..."
          sleep 30

      - name: âœ… VÃ©rification du health check
        run: |
          echo "ğŸ” VÃ©rification du health check..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://portfolio-backend-uj9f.onrender.com/api/health)
          if [ $response -eq 200 ]; then
            echo "âœ… API dÃ©ployÃ©e avec succÃ¨s !"
          else
            echo "âŒ Ã‰chec du health check (HTTP $response)"
            exit 1
          fi

      - name: ğŸ“Š Test des endpoints critiques
        run: |
          echo "ğŸ” Test des endpoints..."

          # Test du profil
          curl -f https://portfolio-backend-uj9f.onrender.com/api/portfolio/profile || exit 1
          echo "âœ… Endpoint /profile OK"

          # Test des expÃ©riences
          curl -f https://portfolio-backend-uj9f.onrender.com/api/portfolio/experience || exit 1
          echo "âœ… Endpoint /experience OK"

          # Test des projets
          curl -f https://portfolio-backend-uj9f.onrender.com/api/portfolio/projects || exit 1
          echo "âœ… Endpoint /projects OK"

      - name: ğŸ“¢ Notification de succÃ¨s
        if: success()
        run: |
          echo "ğŸ‰ DÃ©ploiement rÃ©ussi !"
          echo "ğŸ”— URL: https://portfolio-backend-uj9f.onrender.com"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”– Commit: ${{ github.sha }}"

      - name: âŒ Notification d'Ã©chec
        if: failure()
        run: |
          echo "âŒ Ã‰chec du dÃ©ploiement"
          echo "ğŸ” VÃ©rifiez les logs sur Render Dashboard"
          echo "ğŸ”– Commit: ${{ github.sha }}"
